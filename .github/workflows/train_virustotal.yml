name: Train Model with VirusTotal API

on:
  workflow_dispatch:  # Manual trigger from GitHub Actions tab
    inputs:
      num_urls:
        description: 'Number of URLs per class to process'
        required: true
        default: '20'
        type: string

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install pandas requests tldextract scikit-learn numpy
      
      - name: Debug - List files
        run: |
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          echo "Checking for virustotal files:"
          ls -la virustotal* || echo "No virustotal files found"
      
      - name: Update API key from secret
        run: |
          sed -i "s/VIRUSTOTAL_API_KEY = .*/VIRUSTOTAL_API_KEY = \"${{ secrets.VIRUSTOTAL_API_KEY }}\"/" train_with_virustotal_api.py
      
      - name: Update number of URLs
        run: |
          sed -i "s/num_urls_per_class = .*/num_urls_per_class = ${{ github.event.inputs.num_urls }}/" train_with_virustotal_api.py
      
      - name: Run VirusTotal data collection
        run: |
          python train_with_virustotal_api.py
        timeout-minutes: 120
      
      - name: Train Random Forest model
        run: |
          python train_model.py
        if: always()
      
      - name: Upload trained model artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trained-model-virustotal
          path: |
            website_dataset_virustotal.csv
            random_forest_model.pkl
            model_export.json
          retention-days: 30
      
      - name: Create summary
        if: always()
        run: |
          echo "## Training Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f website_dataset_virustotal.csv ]; then
            echo "âœ… Dataset created: website_dataset_virustotal.csv" >> $GITHUB_STEP_SUMMARY
            lines=$(wc -l < website_dataset_virustotal.csv)
            echo "ðŸ“Š Total samples: $((lines - 1))" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f random_forest_model.pkl ]; then
            echo "âœ… Model trained: random_forest_model.pkl" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f model_export.json ]; then
            echo "âœ… Weights exported: model_export.json" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts from the Actions tab above â¬†ï¸" >> $GITHUB_STEP_SUMMARY
